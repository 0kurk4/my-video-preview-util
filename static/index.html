<!DOCTYPE html>
<html lang="en">
<head>

</head>

<body>

  <h1>Content</h1>


<h2 id="status">Ready</h2>

<form>
    <input type="button" value="JS TEST" id="js_test" onclick="formOnClick()"/>
</form>

<h3 id="file_name"></h3>
<h4 id="duration"></h4>
<img id="preview_image" />

<script>
    console.log('script working');

    async function formOnClick() {
        const statusEl = document.getElementById('status');
        statusEl.innerText = 'Dialog is opened.';

        const buttonEl = document.getElementById('js_test');
        buttonEl.setAttribute("disabled", "disabled");

        let response = await fetch('/getFilePath');
        let text = await response.text();

        console.log(text);
        setTimeout(fetchServerStatus, 200);
    }

    async function fetchServerStatus() {
        let response = await fetch('/serverStatus');
        let text = await response.text();
        console.log('Server status ' + text);
        const statusEl = document.getElementById('status');

        if (text === 'STATUS_PROGRESS') {
            console.log('progress')
            statusEl.innerText = 'Loading video metadata...';
            setTimeout(fetchServerStatus, 200);
        } else if (text === 'STATUS_DIALOG') {
            console.log('dialog')
            statusEl.innerText = 'Dialog is opened.';
            setTimeout(fetchServerStatus, 200);
        } else if (text === 'STATUS_FINISHED') {
            response = await fetch('/getPreview');
            text = await response.json();

            console.log(text);

            const { duration, previewFilePath, fileName } = text;
            const imgEl = document.getElementById('preview_image');
            imgEl.src = '/preview/' + previewFilePath;

            statusEl.innerText = 'Video metadata loaded.';

            const buttonEl = document.getElementById('js_test');
            buttonEl.removeAttribute("disabled");

            const fileNameEl = document.getElementById('file_name');
            fileNameEl.innerText = fileName;

            console.log(new Date(duration * 1000).toISOString());
            
            const durationEl = document.getElementById('duration');
            durationEl.innerText = duration < 3600 
                ? (new Date(duration * 1000).toISOString().substring(14, 19))
                : (new Date(duration * 1000).toISOString().substring(11, 19));

            confirmFinish();
        } else if (text === 'STATUS_ERROR') {
            checkForError();
        } else {
            throw new Error(`PROGRESS_EP error, response not parsed: ${text}`);
        }

        async function checkForError() {
            let response = await fetch('/serverStatusDetail');
            let text = await response.text();
            console.log(`Server Status DETAIL: ${text}`);
            const statusEl = document.getElementById('status');
            statusEl.innerText = text;
            confirmFinish();
        }

        async function confirmFinish() {
            let response = await fetch('/clientFinish');
        }
    }
</script>
</body>
</html>